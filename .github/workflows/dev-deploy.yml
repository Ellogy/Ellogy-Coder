name: Build & Deploy Ellogy Coder

on:
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build & Push GHCR Image
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN_GITHUB }}

      - name: Build docker compose (development profile)
        run: docker compose --profile development build --no-cache

      - name: Tag image
        run: |
          docker tag bolt-ai:development ghcr.io/ellogy/ellogy-coder:latest

      - name: Push image to GHCR
        run: docker push ghcr.io/ellogy/ellogy-coder:latest

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add VM to known_hosts
        run: ssh-keyscan -H ${{ secrets.DEV_VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy on VM - Safe latest update
        run: |
          ssh ${{ secrets.DEV_VM_USER }}@${{ secrets.DEV_VM_IP }} "
            cd /home/azureuser/Coder &&
            echo '${{ secrets.TOKEN_GITHUB }}' | docker login ghcr.io -u ellogy --password-stdin &&
            if docker image inspect ghcr.io/ellogy/ellogy-coder:latest > /dev/null 2>&1; then
              docker tag ghcr.io/ellogy/ellogy-coder:latest ghcr.io/ellogy/ellogy-coder:old
            fi &&
            docker compose pull app-dev &&
            docker compose --profile development up -d --force-recreate &&
            if docker image inspect ghcr.io/ellogy/ellogy-coder:old > /dev/null 2>&1; then
              docker rmi ghcr.io/ellogy/ellogy-coder:old
            fi
          "
