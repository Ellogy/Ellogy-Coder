name: Build & Deploy Ellogy Coder

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add VM to known_hosts
        run: ssh-keyscan -H ${{ secrets.DEV_VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy on VM - Clone, Build and Run
        run: |
          ssh ${{ secrets.DEV_VM_USER }}@${{ secrets.DEV_VM_IP }} "
            # Clone or update repository (repo: Ellogy-Coder, directory: Coder)
            if [ -d /home/azureuser/Coder ]; then
              echo 'Repository exists, updating...' &&
              cd /home/azureuser/Coder &&
              git fetch origin &&
              git reset --hard origin/${{ github.ref_name }} || git reset --hard origin/main
            else
              echo 'Cloning repository...' &&
              cd /home/azureuser &&
              git clone https://github.com/${{ github.repository }}.git Coder &&
              cd Coder &&
              git checkout ${{ github.ref_name }} || git checkout main
            fi &&
            cd /home/azureuser/Coder &&
            # Create .env file
            echo 'Creating .env file...' &&
            cat > .env << EOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          VITE_LOG_LEVEL=debug
          DEFAULT_NUM_CTX=32768
          RUNNING_IN_DOCKER=true
          NODE_ENV=development
          EOF
            # Create .env.local file (same content)
            echo 'Creating .env.local file...' &&
            cat > .env.local << EOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          VITE_LOG_LEVEL=debug
          DEFAULT_NUM_CTX=32768
          RUNNING_IN_DOCKER=true
          NODE_ENV=development
          EOF
            # Build with docker-compose
            echo 'Building Docker images...' &&
            docker-compose --profile development build --no-cache &&
            # Stop existing containers
            docker-compose --profile development down || true &&
            # Start containers
            echo 'Starting containers...' &&
            export COMPOSE_HTTP_TIMEOUT=300 &&
            docker-compose --profile development up -d &&
            # Clean up dangling images (none)
            echo 'Cleaning up dangling Docker images...' &&
            docker image prune -f
          "
